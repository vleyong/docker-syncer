name: åŒé‡åŒæ­¥ (é˜¿é‡Œäº‘ + GHCR)

on:
  workflow_dispatch:
    inputs:
      image_name:
        description: 'åŸé•œåƒåç§° (å¦‚: mysql:8.0)'
        required: true
        default: 'nginx:alpine'

env:
  # é˜¿é‡Œäº‘é…ç½®
  ALIYUN_REGISTRY: ${{ secrets.ALIYUN_REGISTRY }}
  ALIYUN_NAMESPACE: ${{ secrets.ALIYUN_NAMESPACE }}
  # GHCR é…ç½®
  GHCR_REGISTRY: ghcr.io

jobs:
  double-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write # å¿…é¡»èµ‹äºˆå†™ GHCR çš„æƒé™

    steps:
      - name: 1. ç™»å½•é˜¿é‡Œäº‘
        uses: docker/login-action@v2
        with:
          registry: ${{ env.ALIYUN_REGISTRY }}
          username: ${{ secrets.ALIYUN_USERNAME }}
          password: ${{ secrets.ALIYUN_PASSWORD }}

      - name: 2. ç™»å½• GHCR
        uses: docker/login-action@v2
        with:
          registry: ${{ env.GHCR_REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: 3. æ‹‰å–åŸé•œåƒ
        run: |
          docker pull ${{ inputs.image_name }}

      - name: 4. æ¨é€åˆ° é˜¿é‡Œäº‘
        run: |
          # æå–é•œåƒåå’Œæ ‡ç­¾ (ä¾‹å¦‚ mysql:8.0)
          IMAGE_TAG=$(echo "${{ inputs.image_name }}" | awk -F'/' '{print $NF}')
          
          # ç»„åˆåœ°å€
          ALI_TARGET="$ALIYUN_REGISTRY/$ALIYUN_NAMESPACE/$IMAGE_TAG"
          
          echo "ğŸš€ æ¨é€è‡³é˜¿é‡Œäº‘: $ALI_TARGET"
          docker tag ${{ inputs.image_name }} $ALI_TARGET
          docker push $ALI_TARGET

      - name: 5. æ¨é€åˆ° GHCR
        run: |
          IMAGE_TAG=$(echo "${{ inputs.image_name }}" | awk -F'/' '{print $NF}')
          
          # å…³é”®æ­¥éª¤ï¼šGitHub ç”¨æˆ·åè½¬å°å†™ (GHCR å¼ºåˆ¶è¦æ±‚)
          OWNER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          
          # ç»„åˆåœ°å€
          GHCR_TARGET="$GHCR_REGISTRY/$OWNER/$IMAGE_TAG"
          
          echo "ğŸš€ æ¨é€è‡³ GHCR: $GHCR_TARGET"
          docker tag ${{ inputs.image_name }} $GHCR_TARGET
          docker push $GHCR_TARGET

      - name: 6. æ€»ç»“
        run: |
          echo "âœ… åŒæ­¥å®Œæˆï¼"
