name: 镜像搬运工 (DockerHub -> GHCR)

on:
  workflow_dispatch:
    inputs:
      image_name:
        description: '原镜像名称 (例如: mysql:8.0)'
        required: true
        default: 'nginx:alpine'
      target_name:
        description: '保存名称 (可选，留空则保持原名)'
        required: false

env:
  REGISTRY: ghcr.io

jobs:
  mirror:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write # 必须有这个权限才能推送到 GHCR

    steps:
      - name: 登录到 GHCR
        uses: docker/login-action@v2
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
          # GITHUB_TOKEN 是系统自带的，无需配置 Secrets

      - name: 拉取、重命名并推送
        run: |
          # 1. 确定源镜像和目标镜像名
          SRC_IMAGE="${{ inputs.image_name }}"
          
          # 获取仓库所属的用户名 (必须转为小写，GHCR 不支持大写)
          OWNER=$(echo "${{ github.repository_owner }}" | tr '[:upper:]' '[:lower:]')
          
          if [ -z "${{ inputs.target_name }}" ]; then
            # 如果没填目标名，就提取源镜像的名字 (例如 mysql:8.0 -> mysql)
            IMAGE_TAG=$(echo "$SRC_IMAGE" | awk -F'/' '{print $NF}')
          else
            IMAGE_TAG="${{ inputs.target_name }}"
          fi

          # 组合最终的 GHCR 地址
          # 格式: ghcr.io/用户名/镜像名:标签
          TARGET_IMAGE="$REGISTRY/$OWNER/$IMAGE_TAG"

          echo "🚀 正在从 DockerHub 拉取: $SRC_IMAGE"
          docker pull $SRC_IMAGE

          echo "🏷️ 正在打标签: $TARGET_IMAGE"
          docker tag $SRC_IMAGE $TARGET_IMAGE

          echo "📦 正在推送到 GHCR..."
          docker push $TARGET_IMAGE

          echo "✅ 完成！拉取命令: docker pull $TARGET_IMAGE"
