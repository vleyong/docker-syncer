name: 03. è‡ªåŠ¨åŒæ­¥ (From image.txt to Aliyun)

on:
  push:
    paths:
      - "images.txt"
  schedule:
    - cron: "0 0 1,15 * *"
  workflow_dispatch:
    inputs:
      force_sync:
        description: "å¼ºåˆ¶åŒæ­¥ (è·³è¿‡æ‘˜è¦æ¯”å¯¹)"
        required: false
        type: boolean
        default: false

env:
  WEBHOOK_URL: ${{ secrets.WEBHOOK_URL }}
  ALIYUN_REGISTRY: ${{ secrets.ALIYUN_REGISTRY }}
  ALIYUN_NAMESPACE: ${{ secrets.ALIYUN_NAMESPACE }}

jobs:
  sync-images:
    runs-on: ubuntu-latest
    steps:
      - name: â¬‡ï¸ æ‹‰å–ä»£ç 
        uses: actions/checkout@v4

      - name: ğŸ› ï¸ æ£€æŸ¥ Secrets é…ç½®
        run: |
          if [ -z "${{ secrets.ALIYUN_USERNAME }}" ] || [ -z "${{ secrets.ALIYUN_PASSWORD }}" ]; then
            echo "âŒ é”™è¯¯: æœªé…ç½® ALIYUN_USERNAME æˆ– ALIYUN_PASSWORDã€‚"
            exit 1
          fi

      - name: ğŸ”‘ ç™»å½•é˜¿é‡Œäº‘ ACR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.ALIYUN_REGISTRY }}
          username: ${{ secrets.ALIYUN_USERNAME }}
          password: ${{ secrets.ALIYUN_PASSWORD }}

      - name: ğŸš€ æ‰§è¡ŒåŒæ­¥é€»è¾‘
        run: |
          # å®šä¹‰é‡è¯•å‡½æ•°
          function retry {
            local n=1; local max=3; local delay=5
            while true; do
              "$@" && break || {
                if [[ $n -lt $max ]]; then
                  ((n++)); echo "âš ï¸ å¤±è´¥ï¼Œæ­£åœ¨é‡è¯• $n/$max..."; sleep $delay;
                else
                  echo "âŒ å°è¯• $max æ¬¡åä»ç„¶å¤±è´¥ã€‚"; return 1
                fi
              }
            done
          }

          # å¾ªç¯è¯»å– image.txt ä¸­çš„æ¯ä¸€è¡Œ
          while IFS= read -r line || [ -n "$line" ]; do
            # è·³è¿‡ç©ºè¡Œå’Œæ³¨é‡Š
            [[ -z "$line" || "$line" =~ ^# ]] && continue
            
            SRC_IMAGE=$(echo "$line" | xargs)
            echo "------------------------------------------"
            echo "ğŸ“¦ æ­£åœ¨å¤„ç†é•œåƒ: $SRC_IMAGE"

            # è®¡ç®—ç›®æ ‡é•œåƒå (è‡ªåŠ¨å¤„ç†åº“å_é•œåƒå)
            # ä¾‹å¦‚: apache/doris:fe -> aliyun/namespace/apache_doris:fe
            SCOPE=$(echo "$SRC_IMAGE" | awk -F'/' '{if (NF>2) print $(NF-1); else if (NF==2 && $1!="library") print $1; else print ""}')
            BASE_NAME=$(echo "$SRC_IMAGE" | awk -F'/' '{print $NF}')
            
            if [ -n "$SCOPE" ]; then
              TARGET_TAG="${SCOPE}_${BASE_NAME}"
            else
              TARGET_TAG="${BASE_NAME}"
            fi
            
            ALI_TARGET="$ALIYUN_REGISTRY/$ALIYUN_NAMESPACE/$TARGET_TAG"

            # æ‰§è¡ŒåŒæ­¥
            echo "ğŸ” æ£€æŸ¥æ‘˜è¦..."
            NEED_SYNC=true
            SRC_DIGEST=$(retry skopeo inspect "docker://$SRC_IMAGE" --format='{{.Digest}}' 2>/dev/null || echo "")
            DEST_DIGEST=$(retry skopeo inspect "docker://$ALI_TARGET" --format='{{.Digest}}' 2>/dev/null || echo "")

            if [ -n "$SRC_DIGEST" ] && [ "$SRC_DIGEST" == "$DEST_DIGEST" ]; then
              echo "âœ… æ‘˜è¦ä¸€è‡´ï¼Œè·³è¿‡åŒæ­¥ã€‚"
              NEED_SYNC=false
            fi

            if [ "$NEED_SYNC" == "true" ]; then
              echo "ğŸ“¥ Pulling $SRC_IMAGE ..."
              retry docker pull "$SRC_IMAGE"
              
              echo "ğŸ·ï¸ Tagging as $ALI_TARGET ..."
              docker tag "$SRC_IMAGE" "$ALI_TARGET"
              
              echo "ğŸ“¤ Pushing to Aliyun ..."
              retry docker push "$ALI_TARGET"
              
              echo "ğŸ§¹ æ¸…ç†æœ¬åœ°é•œåƒ ..."
              docker rmi "$SRC_IMAGE" "$ALI_TARGET" || true
              echo "âœ¨ $SRC_IMAGE åŒæ­¥å®Œæˆ!"
            fi
          done < image.txt

      - name: ğŸ”” å‘é€ Webhook é€šçŸ¥
        if: always()
        run: |
          if [ -z "$WEBHOOK_URL" ]; then exit 0; fi
          
          STATUS="${{ job.status == 'success' && 'âœ… æˆåŠŸ' || 'âŒ å¤±è´¥' }}"
          MSG="é˜¿é‡Œäº‘é•œåƒåŒæ­¥ç»“æœ: $STATUS\nä»“åº“: ${{ github.repository }}\næŸ¥çœ‹æ—¥å¿—: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          
          curl -X POST -H "Content-Type: application/json" \
            -d "{\"msg_type\":\"text\",\"content\":{\"text\":\"$MSG\"}}" \
            "$WEBHOOK_URL"
