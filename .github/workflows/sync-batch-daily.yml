name: æ‰¹é‡åŒæ­¥ (Batch Sync)

on:
  schedule:
    # æ¯æœˆ 1å· å’Œ 15å· åŒ—äº¬æ—¶é—´ 08:00 (UTC 00:00) è¿è¡Œ
    - cron: "0 0 1,15 * *"
  workflow_dispatch:
    inputs:
      force_sync:
        description: 'å¼ºåˆ¶åŒæ­¥ (è·³è¿‡æ‘˜è¦æ¯”å¯¹)'
        required: false
        type: boolean
        default: false

env:
  ALIYUN_REGISTRY: ${{ secrets.ALIYUN_REGISTRY }}
  ALIYUN_NAMESPACE: ${{ secrets.ALIYUN_NAMESPACE }}

jobs:
  batch-sync:
    runs-on: ubuntu-latest
    steps:
      # 1. æè‡´ç©ºé—´æ¸…ç† (åœ¨æ‹‰å–ä»»ä½•ä¸œè¥¿ä¹‹å‰)
      - name: ğŸ—‘ï¸ æ¸…ç†ç£ç›˜ç©ºé—´ (Max Optimization)
        uses: easimon/maximize-build-space@master
        with:
          root-reserve-mb: 2048
          swap-size-mb: 128
          remove-dotnet: 'true'
          remove-android: 'true'
          remove-haskell: 'true'
          remove-codeql: 'true'
          build-mount-path: '/var/lib/docker/'

      - name: é‡å¯ Docker æœåŠ¡
        run: sudo service docker restart

      - name: Checkout Code
        uses: actions/checkout@v3

      - name: ç™»å½•é˜¿é‡Œäº‘ ACR
        uses: docker/login-action@v2
        with:
          registry: ${{ env.ALIYUN_REGISTRY }}
          username: ${{ secrets.ALIYUN_USERNAME }}
          password: ${{ secrets.ALIYUN_PASSWORD }}

      - name: ç™»å½• DockerHub (é¿å…é™æµ)
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
        continue-on-error: true

      - name: ğŸ“¦ æ‰¹é‡å¤„ç†é•œåƒ
        run: |
          # æ£€æŸ¥ images.txt
          if [ ! -f "images.txt" ]; then
            echo "âŒ images.txt ä¸å­˜åœ¨ï¼Œè·³è¿‡åŒæ­¥ã€‚"
            exit 0
          fi

          echo "ğŸ“‹ å¼€å§‹å¤„ç†é•œåƒåˆ—è¡¨..."
          
          # é€è¡Œè¯»å–
          while IFS= read -r line || [ -n "$line" ]; do
            # 1. é¢„å¤„ç†ï¼šå»é™¤é¦–å°¾ç©ºæ ¼
            line=$(echo "$line" | xargs)
            
            # 2. å¿½ç•¥ç©ºè¡Œå’Œæ³¨é‡Š
            [[ -z "$line" || "$line" =~ ^# ]] && continue

            echo "=================================================================="
            echo "ğŸ”„ åŸå§‹æŒ‡ä»¤: $line"

            # 3. è§£æå‚æ•° (--platform) å’Œ é•œåƒå
            # æå–å¹³å°å‚æ•°ï¼Œä¾‹å¦‚ --platform=linux/arm64
            PLATFORM_ARG=""
            if [[ "$line" == *"--platform"* ]]; then
              # æå– --platform=xxx æˆ–è€… --platform xxx
              # è¿™é‡Œç®€å•åŒ¹é… --platform=xxxxx
              PLATFORM_VAL=$(echo "$line" | grep -oP '(?<=--platform[ =])\S+')
              if [ -n "$PLATFORM_VAL" ]; then
                 PLATFORM_ARG="--platform $PLATFORM_VAL"
                 echo "âš™ï¸ æŒ‡å®šæ¶æ„: $PLATFORM_VAL"
              fi
            fi

            # æå–é•œåƒåç§° (å–è¯¥è¡Œçš„æœ€åä¸€ä¸ªå­—æ®µ)
            SRC_IMAGE=$(echo "$line" | awk '{print $NF}')
            
            # 4. æ™ºèƒ½å‘½åç­–ç•¥ (Smart Prefix)
            # æå–å‘½åç©ºé—´ (å¦‚ bitnami/nginx -> bitnami)
            SCOPE=$(echo "$SRC_IMAGE" | awk -F'/' '{if (NF>2) print $(NF-1); else if (NF==2 && $1!="library") print $1; else print ""}')
            # æå–é•œåƒå+Tag (å¦‚ nginx:latest)
            BASE_NAME=$(echo "$SRC_IMAGE" | awk -F'/' '{print $NF}')
            
            if [ -n "$SCOPE" ]; then
               # å¦‚æœæœ‰éå®˜æ–¹å‘½åç©ºé—´ï¼ŒåŠ å‰ç¼€ï¼Œé˜²æ­¢å†²çª (e.g. bitnami_nginx:latest)
               TARGET_TAG="${SCOPE}_${BASE_NAME}"
            else
               # å®˜æ–¹é•œåƒä¿æŒåŸæ · (e.g. nginx:latest)
               TARGET_TAG="${BASE_NAME}"
            fi
            
            # å¦‚æœæŒ‡å®šäº†æ¶æ„ï¼Œå»ºè®®åœ¨ Tag é‡Œä¹Ÿä½“ç°ï¼Œé˜²æ­¢åŒåä¸åŒæ¶æ„è¦†ç›–
            if [ -n "$PLATFORM_VAL" ]; then
               # å°† linux/arm64 è½¬ä¸º linux_arm64
               PLATFORM_TAG=$(echo "$PLATFORM_VAL" | sed 's/\//_/g')
               TARGET_TAG="${PLATFORM_TAG}_${TARGET_TAG}"
            fi

            ALI_TARGET="$ALIYUN_REGISTRY/$ALIYUN_NAMESPACE/$TARGET_TAG"
            
            # 5. æ™ºèƒ½æ‘˜è¦æ¯”å¯¹ (Skopeo Check)
            FORCE="${{ inputs.force_sync }}"
            NEED_PULL=true

            if [ "$FORCE" == "false" ]; then
               echo "ğŸ” æ­£åœ¨æ¯”å¯¹ Digest..."
               # è·å–æºé•œåƒ Digest (å¤„ç†å¤šæ¶æ„æƒ…å†µï¼Œinspect å¯èƒ½è¿”å›åˆ—è¡¨ï¼Œè¿™é‡Œç®€åŒ–å–ç¬¬ä¸€ä¸ªæˆ–ä¸» Digest)
               # æ³¨æ„ï¼šåŠ ä¸Š PLATFORM_ARG ä¼ ç»™ skopeo (å¦‚æœ skopeo æ”¯æŒçš„è¯ï¼Œæˆ–è€…å¿½ç•¥)
               # ç®€å•èµ·è§ï¼Œæˆ‘ä»¬å¯¹æ¯” docker pull ä¼šæ‹‰å–åˆ°çš„é‚£ä¸ª manifest digest
               
               SRC_DIGEST=$(skopeo inspect docker://$SRC_IMAGE --format='{{.Digest}}' 2>/dev/null || echo "")
               DEST_DIGEST=$(skopeo inspect docker://$ALI_TARGET --format='{{.Digest}}' 2>/dev/null || echo "")
               
               if [ -n "$SRC_DIGEST" ] && [ "$SRC_DIGEST" == "$DEST_DIGEST" ]; then
                  echo "âœ… é•œåƒå·²æ˜¯æœ€æ–° (Digest: ${SRC_DIGEST:0:12})ï¼Œè·³è¿‡åŒæ­¥ã€‚"
                  NEED_PULL=false
               else
                  echo "ğŸš€ å‘ç°æ›´æ–° (æˆ–ç›®æ ‡ä¸å­˜åœ¨)ï¼Œå‡†å¤‡åŒæ­¥..."
                  echo "   æº: ${SRC_DIGEST:0:12} vs ç›®æ ‡: ${DEST_DIGEST:0:12}"
               fi
            else
               echo "âš ï¸ å¼ºåˆ¶åŒæ­¥æ¨¡å¼ï¼Œè·³è¿‡æ¯”å¯¹ã€‚"
            fi

            # 6. æ‰§è¡ŒåŒæ­¥ (è¾¹ä¸‹è¾¹åˆ )
            if [ "$NEED_PULL" == "true" ]; then
               echo "ğŸ“¥ æ‹‰å–: $SRC_IMAGE $PLATFORM_ARG"
               docker pull $SRC_IMAGE $PLATFORM_ARG
               
               echo "ğŸ·ï¸ æ‰“æ ‡ç­¾: $ALI_TARGET"
               docker tag $SRC_IMAGE $ALI_TARGET
               
               echo "ğŸ“¤ æ¨é€: $ALI_TARGET"
               docker push $ALI_TARGET
               
               # 7. ç«‹å³æ¸…ç† (å…³é”®æ­¥éª¤)
               echo "ğŸ§¹ æ¸…ç†æœ¬åœ°ç¼“å­˜..."
               docker rmi $SRC_IMAGE $ALI_TARGET || true
               echo "âœ… å®Œæˆï¼"
            fi
            
            # æ‰“å°å½“å‰ç£ç›˜å‰©ä½™
            df -h | grep "/var/lib/docker" || true

          done < images.txt
